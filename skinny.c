#include <stdint.h>
#include "skinny.h"
#include <stdio.h>
#include <string.h>
static const unsigned char S8 [] = {
  0x65 ,0x4c ,0x6a ,0x42 ,0x4b ,0x63 ,0x43 ,0x6b ,0x55 ,0x75 ,0x5a ,0x7a ,0x53 ,0x73 ,0x5b ,0x7b ,
  0x35 ,0x8c ,0x3a ,0x81 ,0x89 ,0x33 ,0x80 ,0x3b ,0x95 ,0x25 ,0x98 ,0x2a ,0x90 ,0x23 ,0x99 ,0x2b ,
  0xe5 ,0xcc ,0xe8 ,0xc1 ,0xc9 ,0xe0 ,0xc0 ,0xe9 ,0xd5 ,0xf5 ,0xd8 ,0xf8 ,0xd0 ,0xf0 ,0xd9 ,0xf9 ,
  0xa5 ,0x1c ,0xa8 ,0x12 ,0x1b ,0xa0 ,0x13 ,0xa9 ,0x05 ,0xb5 ,0x0a ,0xb8 ,0x03 ,0xb0 ,0x0b ,0xb9 ,
  0x32 ,0x88 ,0x3c ,0x85 ,0x8d ,0x34 ,0x84 ,0x3d ,0x91 ,0x22 ,0x9c ,0x2c ,0x94 ,0x24 ,0x9d ,0x2d ,
  0x62 ,0x4a ,0x6c ,0x45 ,0x4d ,0x64 ,0x44 ,0x6d ,0x52 ,0x72 ,0x5c ,0x7c ,0x54 ,0x74 ,0x5d ,0x7d ,
  0xa1 ,0x1a ,0xac ,0x15 ,0x1d ,0xa4 ,0x14 ,0xad ,0x02 ,0xb1 ,0x0c ,0xbc ,0x04 ,0xb4 ,0x0d ,0xbd ,
  0xe1 ,0xc8 ,0xec ,0xc5 ,0xcd ,0xe4 ,0xc4 ,0xed ,0xd1 ,0xf1 ,0xdc ,0xfc ,0xd4 ,0xf4 ,0xdd ,0xfd ,
  0x36 ,0x8e ,0x38 ,0x82 ,0x8b ,0x30 ,0x83 ,0x39 ,0x96 ,0x26 ,0x9a ,0x28 ,0x93 ,0x20 ,0x9b ,0x29 ,
  0x66 ,0x4e ,0x68 ,0x41 ,0x49 ,0x60 ,0x40 ,0x69 ,0x56 ,0x76 ,0x58 ,0x78 ,0x50 ,0x70 ,0x59 ,0x79 ,
  0xa6 ,0x1e ,0xaa ,0x11 ,0x19 ,0xa3 ,0x10 ,0xab ,0x06 ,0xb6 ,0x08 ,0xba ,0x00 ,0xb3 ,0x09 ,0xbb ,
  0xe6 ,0xce ,0xea ,0xc2 ,0xcb ,0xe3 ,0xc3 ,0xeb ,0xd6 ,0xf6 ,0xda ,0xfa ,0xd3 ,0xf3 ,0xdb ,0xfb ,
  0x31 ,0x8a ,0x3e ,0x86 ,0x8f ,0x37 ,0x87 ,0x3f ,0x92 ,0x21 ,0x9e ,0x2e ,0x97 ,0x27 ,0x9f ,0x2f ,
  0x61 ,0x48 ,0x6e ,0x46 ,0x4f ,0x67 ,0x47 ,0x6f ,0x51 ,0x71 ,0x5e ,0x7e ,0x57 ,0x77 ,0x5f ,0x7f ,
  0xa2 ,0x18 ,0xae ,0x16 ,0x1f ,0xa7 ,0x17 ,0xaf ,0x01 ,0xb2 ,0x0e ,0xbe ,0x07 ,0xb7 ,0x0f ,0xbf ,
  0xe2 ,0xca ,0xee ,0xc6 ,0xcf ,0xe7 ,0xc7 ,0xef ,0xd2 ,0xf2 ,0xde ,0xfe ,0xd7 ,0xf7 ,0xdf ,0xff
};
static const unsigned char LFSR [] = {
  0x01, 0x03, 0x07, 0x0F, 0x1F, 0x3E, 0x3D, 0x3B, 0x37, 0x2F, 0x1E, 0x3C, 0x39, 0x33, 0x27, 0x0E,
  0x1D, 0x3A, 0x35, 0x2B, 0x16, 0x2C, 0x18, 0x30, 0x21, 0x02, 0x05, 0x0B, 0x17, 0x2E, 0x1C, 0x38,
  0x31, 0x23, 0x06, 0x0D, 0x1B, 0x36, 0x2D, 0x1A, 0x34, 0x29, 0x12, 0x24, 0x08, 0x11, 0x22, 0x04,
  0x09, 0x13, 0x26, 0x0C, 0x19, 0x32, 0x25, 0x0A, 0x15, 0x2A, 0x14, 0x28, 0x10, 0x20
};

void subCells(unsigned char *subP) {
  for (int i = 0; i < 16; i++)
  {
    subP[i] = S8[subP[i]];
    //printf("subCells %x\n", subP[i]);
  }
}
void addConstant(unsigned char *subP, unsigned int i) {
  unsigned char test = 0x02;
  subP[0] = subP[0]^(LFSR[i]&0x0F);
  if (i > 3) {
    subP[4] = subP[4]^(LFSR[i-4]&0x03);
  }
  subP[8] = subP[8]^test;
  //printf("addConst is %x\n", subP[8]);
}
void addTweakey(unsigned char *subP, unsigned char *tk1, unsigned char *tk2, unsigned char *tk3){
  for (int i = 0; i < 8; i++) {
    subP[i] = subP[i]^tk1[i]^tk2[i]^tk3[i];
  }
  unsigned char newtk1 [] = {
    tk1[9], tk1[15], tk1[8], tk1[13],
    tk1[10], tk1[14], tk1[12], tk1[11],
    tk1[0], tk1[1], tk1[2], tk1[3],
    tk1[4], tk1[5], tk1[6], tk1[7]
  };
  unsigned char newtk2 [] = {
    tk2[9], tk2[15], tk2[8], tk2[13],
    tk2[10], tk2[14], tk2[12], tk2[11],
    tk2[0], tk2[1], tk2[2], tk2[3],
    tk2[4], tk2[5], tk2[6], tk2[7]
  };
  unsigned char newtk3 [] = {
    tk3[9], tk3[15], tk3[8], tk3[13],
    tk3[10], tk3[14], tk3[12], tk3[11],
    tk3[0], tk3[1], tk3[2], tk3[3],
    tk3[4], tk3[5], tk3[6], tk3[7]
  };
  memcpy(tk1, newtk1, 16);
  memcpy(tk2, newtk2, 16);
  memcpy(tk3, newtk3, 16);
  //tk2 lfsr
  for (int i = 0; i < 8; i++)
  {
    unsigned char mask5 = (tk2[i]>>5)&0x01;
    unsigned char x7 = tk2[i]&0x80;
    if (x7 == 0x80){
      tk2[i] = tk2[i]<<1^0x01^mask5;
    } else {
      tk2[i] = tk2[i]<<1^mask5;
    }
  }
  //tk3 lfsr
  for (int i = 0; i < 8; i++)
  {
    unsigned char x0 = tk3[i]&0x01;
    unsigned char x6 = tk3[i]>>6&0x01;
    unsigned char mask0;
    unsigned char mask6;
    if (x0 == 0x01) {
      mask0 = 0x80;
    } else {
      mask0 = 0x00;
    }
    if (x6 == 0x01)
    {
      mask6 = 0x80;
    } else {
      mask6 = 0x00;
    }
    tk3[i] = tk3[i]>>1^mask0^mask6;
  }
}
void shiftRows(unsigned char *subP) {
  unsigned char newsubP [16] = {
    subP[0], subP[1], subP[2], subP[3],
    subP[7], subP[4], subP[5], subP[6],
    subP[10], subP[11], subP[8], subP[9],
    subP[13], subP[14], subP[15], subP[12]
  };
  memcpy(subP, newsubP, 16);
}
void mixColumns(unsigned char *subP) {
  unsigned char column2 [4] = {
    subP[4]^subP[8], subP[5]^subP[9], subP[6]^subP[10], subP[7]^subP[11]
  };
  unsigned char column3 [4] = {
    subP[0]^subP[8], subP[1]^subP[9], subP[2]^subP[10], subP[3]^subP[11]
  };
  unsigned char column4 [4] = {
    column3[0]^subP[12], column3[1]^subP[13], column3[2]^subP[14], column3[3]^subP[15]
  };
  unsigned char newsubP [16] = {
    column4[0], column4[1], column4[2], column4[3],
    subP[0], subP[1], subP[2], subP[3],
    column2[0], column2[1], column2[2], column2[3],
    column3[0], column3[1], column3[2], column3[3]
  };
  memcpy(subP, newsubP, 16);


}
/**
 * SKINNY-128-384 block cipher encryption.
 * Under 48-byte tweakey at k, encrypt 16-byte plaintext at p and store the 16-byte output at c.
 */
void skinny(unsigned char *c, const unsigned char *p, const unsigned char *k) {
  unsigned char tk1 [16];
  unsigned char tk2 [16];
  unsigned char tk3 [16];
  memcpy(tk1, k, 16);
  memcpy(tk2, k+16, 16);
  memcpy(tk3, k+32, 16);
  unsigned char subP [16];
  memcpy(subP, p, 16);
  
  for (int i = 0; i < 56; i++)
  {
    subCells(subP);
    addConstant(subP, i);
    addTweakey(subP, tk1, tk2, tk3);
    shiftRows(subP);
    mixColumns(subP);
  }
  memcpy(c, subP, 16);
  
}